image: stepansib/php-js-nginx-symfony-oro:7.1

services:
  - mysql:5.6
  - selenium/standalone-chrome

variables:
  GIT_STRATEGY: clone
  MYSQL_DATABASE: app
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: user
  MYSQL_PASSWORD: user

before_script:
  - bash ci/utils/docker_install.sh
  - rm -rf ./tests/_output/*
  - cp ./ci/app_config/parameters.gitlab-ci.yml.dist ./app/config/parameters.yml.dist
  - bash ci/utils/app_install.sh
  - bash ci/utils/flush_permissions.sh

cache: 
  key: "$CI_PROJECT_NAME" # Or use "$CI_PIPELINE_ID" "$CI_PROJECT_NAME" "$CI_COMMIT_REF_NAME" "$CI_PROJECT_ID"
  untracked: true
  paths:
    - ./vendor

stages:
  - diff_test
  - full_test

diff_test:
  stage: diff_test
  environment: test
  only:
    - develop
    - /^hotfix/.*$/
    - /^feature/.*$/
  script:
    - bash ci/tests/acceptance_new.sh
  artifacts:
    paths:
    - ./tests/_output/*
    when: on_failure
    expire_in: 1 week

full_test:
  stage: full_test
  environment: test
  only:
    - test
    - master
    - /^release/.*$/
  script:
    - bash ci/tests/acceptance_all.sh
  artifacts:
    paths:
    - ./tests/_output/*
    when: on_failure
    expire_in: 1 week
