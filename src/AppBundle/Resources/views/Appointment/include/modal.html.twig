<script>

    $('body').on('submit', 'form.app-appointment-form', function (e) {
        e.preventDefault();

        var form = $(this);
        ajaxFormHandler(form, function (data) {
            render();
            if (!data.error) {
                if (typeof refreshCalendarWidget === 'function') {
                    refreshCalendarWidget();
                } else {
                    redirectToCal();
                    $("#calendar").fullCalendar('refetchEvents');
                }
            }
        });
    });

    /*
    // Looks unused, maybe we need to delete it
    $('body').on('submit', 'form.app-appointment-form-with-patient', function (e) {
        e.preventDefault();

        var form = $(this);
        ajaxFormHandler(form, function (data) {
            render();
            if (!data.error) {
                $("#calendar").fullCalendar('refetchEvents');
            }
        });
    });
    */

    $('body').on('click', '.app-appointment-create', function (e) {
        e.preventDefault();
        appointmentCreate();
    });

    $('body').on('click', '.cancel-reschedule', function (e) {
        e.preventDefault();
        var url = Routing.generate('calendar_index');
        window.location.href = url;
    });

    $('body').on('change', 'form.app-appointment-form #app_appointment_treatment', function (e) {
        var duration = $(this).find('option:selected').data('duration');
        if (typeof duration !== 'undefined' && duration > 0) {

            var h = $('form.app-appointment-form .app-event-time-start select[name="h"]').val();
            var m = $('form.app-appointment-form .app-event-time-start select[name="m"]').val();
            var ampm = $('form.app-appointment-form .app-event-time-start select[name="ampm"]').val();

            var url = Routing.generate('event_end_time', {
                'h': h,
                'm': m,
                'ampm': ampm,
                'd': duration,
            });

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {},
                success: function (data, textStatus) {
                    $('form.app-appointment-form .app-event-time-end select[name="h"] option[value="' + data.h + '"]').prop('selected', true);
                    $('form.app-appointment-form .app-event-time-end select[name="m"] option[value="' + data.m + '"]').prop('selected', true);
                    $('form.app-appointment-form .app-event-time-end select[name="ampm"] option[value="' + data.ampm + '"]').prop('selected', true);
                    $('form.app-appointment-form .app-event-time-end select[name="h"]').trigger('change');
                }
            });
        }
    });

    $('body').on('click', '.app-appointment-edit', function (e) {
        e.preventDefault();

        var appointmentId = $(this).data('entityId');

        var parentModal = $(this).parents('.modal:first');
        if ($(parentModal).length) {
            eventEdit(appointmentId, parentModal);
            return;
        }

        eventEdit(appointmentId);
    });

    $('body').on('click', '.app-appointment-view', function (e) {
        e.preventDefault();

        var appointmentId = $(this).data('entityId');

        var parentModal = $(this).parents('.modal:first');
        if ($(parentModal).length) {
            eventView(appointmentId, parentModal);
            return;
        }

        eventView(appointmentId);
    });

    $('body').on('click', '.app-patient-arrived', function (e) {
        e.preventDefault();

        loaderShow();

        var button = $(this);
        var appointmentId = $(this).data('entityId');

        var url = Routing.generate('appointment_patient_arrived', {
            'id': appointmentId
        });

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            data: {},
            success: function (data, textStatus) {
                loaderHide();
                $('#calendar').fullCalendar('refetchEvents');
                if (data.state == "1") {
                    notify('app.appointment.message.patient_arrived', 'success');
                    $(button).addClass('arrived');
                    $('.app-appointment-cancel-container').addClass('display-none');
                } else {
                    notify('app.appointment.message.patient_not_arrived', 'success');
                    $(button).removeClass('arrived');
                    $('.app-appointment-cancel-container').removeClass('display-none');
                }
            },
            error: function () {
                notify('app.message.undefined_error', 'danger');
                loaderHide();
            }
        });
    });

    $('body').on('click', '.app-appointment-cancel', function (e) {
        e.preventDefault();

        loaderShow();

        var modal = $(this).parents('.modal:first');
        var appointmentId = $(this).data('entityId');
        var reasonId = $(this).data('cancelReasonId');

        var url = Routing.generate('appointment_cancel', {
            'id': appointmentId,
            'reason': reasonId
        });

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            data: {},
            success: function (data, textStatus) {
                loaderHide();
                notify('app.appointment.message.cancelled', 'success');
                $(modal).modal('hide');
                $('#calendar').fullCalendar('refetchEvents');
            },
            error: function () {
                notify('app.message.undefined_error', 'danger');
                loaderHide();
            }
        });
    });

    $('body').on("click", '[data-toggle="delete-confirmation-event"]', function (e) {
        var modal = $(this).parents('.modal:first');
        var deleteUrl = $(this).data('href');

        deleteConfirmationHandler($(this), function () {
            loaderShow();
            $.ajax({
                url: deleteUrl,
                type: "GET",
                dataType: "json",
                data: {},
                success: function (data, textStatus) {
                    notify('app.event.message.deleted', 'success');
                    $(modal).modal('hide');
                    $('#calendar').fullCalendar('refetchEvents');
                },
                error: function () {
                    loaderHide();
                    $('#calendar').fullCalendar('refetchEvents');
                    notify('app.message.undefined_error', 'danger');
                }
            });
        });
    });

    function appointmentCreate(date, resourceIndex, patient) {
        var routeParams = {};
        if (typeof patient !== 'undefined') {
            routeParams.patient = patient;
        }
        routeParams.resourceId = resourceIndex;
        eventCreate(date, 'appointment_create', routeParams);
    }


</script>
