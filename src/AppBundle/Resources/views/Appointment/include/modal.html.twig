<script>

    $('body').on('submit', 'form.app-appointment-form', function (e) {
        e.preventDefault();

        var form = $(this);
        ajaxFormHandler(form, function (data) {
            render();
            if (!data.error) {
                redirectToCal();
                $("#calendar").fullCalendar('refetchEvents');
            }
        });
    });

    $('body').on('submit', 'form.app-appointment-form-with-patient', function (e) {
        e.preventDefault();

        var form = $(this);
        ajaxFormHandler(form, function (data) {
            render();
            if (!data.error) {
                $("#calendar").fullCalendar('refetchEvents');
            }
        });
    });

    $('body').on('click', '.app-appointment-create', function (e) {
        e.preventDefault();
        appointmentCreate();
    });

    $('body').on('click', '.app-appointment-create-with-patient', function (e) {
        e.preventDefault();
        appointmentCreateWithPatient();
    });

    $('body').on('click', '.app-appointment-edit', function (e) {
        e.preventDefault();

        var appointmentId = $(this).data('entityId');

        var parentModal = $(this).parents('.modal:first');
        if ($(parentModal).length) {
            eventEdit(appointmentId, parentModal);
            return;
        }

        eventEdit(appointmentId);
    });

    $('body').on('click', '.app-appointment-view', function (e) {
        e.preventDefault();

        var appointmentId = $(this).data('entityId');

        var parentModal = $(this).parents('.modal:first');
        if ($(parentModal).length) {
            eventView(appointmentId, parentModal);
            return;
        }

        eventView(appointmentId);
    });

    $('body').on('click', '.app-patient-arrived', function (e) {
        e.preventDefault();

        loaderShow();

        var button = $(this);
        var appointmentId = $(this).data('entityId');

        var url = Routing.generate('appointment_patient_arrived', {
            'id': appointmentId
        });

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            data: {},
            success: function (data, textStatus) {
                loaderHide();
                notify('app.appointment.message.patient_arrived', 'success');
                $('#calendar').fullCalendar('refetchEvents');
                $(button).remove();
            },
            error: function () {
                notify('app.message.undefined_error', 'danger');
                loaderHide();
            }
        });
    });

    $('body').on('click', '.app-appointment-cancel', function (e) {
        e.preventDefault();

        loaderShow();

        var modal = $(this).parents('.modal:first');
        var appointmentId = $(this).data('entityId');
        var reasonId = $(this).data('cancelReasonId');

        var url = Routing.generate('appointment_cancel', {
            'id': appointmentId,
            'reason': reasonId
        });

        $.ajax({
            url: url,
            type: "POST",
            dataType: "json",
            data: {},
            success: function (data, textStatus) {
                loaderHide();
                notify('app.appointment.message.cancelled', 'success');
                $(modal).modal('hide');
                $('#calendar').fullCalendar('refetchEvents');
            },
            error: function () {
                notify('app.message.undefined_error', 'danger');
                loaderHide();
            }
        });
    });

    $('body').on("click", '[data-toggle="delete-confirmation-event"]', function (e) {
        var modal = $(this).parents('.modal:first');
        var deleteUrl = $(this).data('href');

        deleteConfirmationHandler($(this), function () {
            loaderShow();
            $.ajax({
                url: deleteUrl,
                type: "GET",
                dataType: "json",
                data: {},
                success: function (data, textStatus) {
                    notify('app.event.message.deleted', 'success');
                    $(modal).modal('hide');
                    $('#calendar').fullCalendar('refetchEvents');
                },
                error: function () {
                    loaderHide();
                    $('#calendar').fullCalendar('refetchEvents');
                    notify('app.message.undefined_error', 'danger');
                }
            });
        });
    });

    function appointmentCreate(date, patient) {
        var routeParams = {};
        if (typeof patient !== 'undefined') {
            routeParams.patient = patient;
        }
        eventCreate(date, 'appointment_create', routeParams, '{{ 'app.appointment.new'|trans }}');
    }

    function appointmentCreateWithPatient(date) {
        eventCreate(date, 'appointment_create_with_new_patient', {}, '{{ 'app.appointment.new'|trans }}');
    }


</script>
