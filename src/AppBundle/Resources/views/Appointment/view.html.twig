<div class="modal-dialog" role="document">
    <div class="modal-content" id="appointment-modal">

        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">
                {{ entity.treatment }}
            </h4>
            <div class="appt-time">
                {{ entity.start|app_date_and_week_day_full }}
                <span>{{ 'app.event.at'|trans }}</span> {{ entity.start|app_time }}
                <span>{{ 'app.event.for'|trans }}</span> {{ entity.getDurationInMinutes }} {{ 'app.event.minutes'|trans }}
            </div>
        </div>

        <div class="attendee-list">

            {% for appointmentPatient in entity.appointmentPatients %}

                <div class="modal-body">
                    <div class="row">

                        <div class="col-md-8">
                            <div class="appt-info">
                                <strong>
                                    <a href="{{ path('patient_view',{'id':app_hash(appointmentPatient.patient)}) }}">{{ appointmentPatient.patient }}
                                        (Ref: {{ appointmentPatient.patient.patientNumberFormatted }})</a>
                                </strong><br>
                                {% if appointmentPatient.patient.mobilePhone %}
                                    {{ appointmentPatient.patient.mobilePhone }}<br>
                                {% endif %}
                                {% if appointmentPatient.patient.email %}
                                    <a href="mailto:{{ appointmentPatient.patient.email }}">{{ appointmentPatient.patient.email }}</a>
                                {% endif %}

                                {% if nextAppointment[appointmentPatient.patient.id] is defined %}
                                    <div class="appt-next">
                                        <strong>{{ 'app.appointment.next'|trans }}:</strong><br>
                                        <a href="#" class="app-appointment-view"
                                           data-entity-id="{{ app_hash(nextAppointment[appointmentPatient.patient.id], eventClass) }}">{{ nextAppointment[appointmentPatient.patient.id].start|app_date_and_week_day }}</a>
                                    </div>
                                {% endif %}

                                {% if appointmentPatient.patient.alerts|length %}
                                    {% for alert in appointmentPatient.patient.alerts %}
                                        <div class="appt-alert">
                                            {{ alert }}
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                {% if entity.description %}
                                    <div class="appt-note">
                                        {{ entity.description }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="clearfix"></div>
                        </div>

                        <div class="col-md-4">
                            <div class="appt-actions">
                                <a href="#"
                                   class="btn btn-default {{ appointmentPatient.patientArrived == true ? 'arrived' : '' }}
                            {{ appointmentPatient.noShow == true ? 'display-none' : '' }}
                            btn-block app-patient-arrived "
                                   data-entity-id="{{ app_hash(appointmentPatient) }}"
                                   data-event-id="{{ app_hash(entity, eventClass) }}">
                                    {{ 'app.appointment.patient_arrived'|trans }}
                                </a>

                                <a href="#"
                                   class="btn {{ appointmentPatient.noShow == true ? 'btn-danger' : 'btn-default' }}
                        {{ appointmentPatient.patientArrived == true ? 'display-none' : '' }}
                        app-no-show" data-entity-id="{{ app_hash(appointmentPatient) }}"
                                   data-event-id="{{ app_hash(entity, eventClass) }}">
                                    {{ 'app.appointment.no_show'|trans }}
                                </a>

                                <a href="#"
                                   class="btn btn-default {{ appointmentPatient.noShowMessage ? 'disabled' : 'app-send-no-show ' }} {{ appointmentPatient.noShow == true ? '' : 'display-none' }}"
                                   data-event-id="{{ app_hash(entity, eventClass) }}"
                                   data-entity-id="{{ app_hash(appointmentPatient) }}">
                                    {{ appointmentPatient.noShowMessage ? 'app.appointment.no_show_sent'|trans : 'app.appointment.no_show_send'|trans }}
                                </a>

                                {% if not appointmentPatient.invoice %}
                                    {% if treatmentPackUtils.availableTreatmentPack(appointmentPatient.patient, entity.treatment) %}

                                        <div class="btn-group invoice-or-pack-btn">
                                            <button class="btn btn-success btn-block dropdown-toggle "
                                                    data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">{{ 'app.invoice.invoice_or_pack'|trans }}
                                                <span class="caret"></span></button>

                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a href="{{ path('appointment_invoice_create',{'patient':app_hash(appointmentPatient.patient),'appointmentPatient':app_hash(appointmentPatient)}) }}"
                                                       class="">{{ 'app.invoice.create'|trans }}</a>
                                                </li>
                                                <li>
                                                    <a href="#"
                                                       class="use-pack" data-treatment-name="{{ entity.treatment }}"
                                                       data-patient-name="{{ appointmentPatient.patient }}"
                                                       data-entity-id="{{ app_hash(entity) }}">{{ 'app.treatment_pack.use'|trans }}</a>
                                                </li>
                                            </ul>
                                        </div>

                                    {% else %}

                                        <a href="{{ path('appointment_invoice_create',{'patient':app_hash(appointmentPatient.patient),'appointmentPatient':app_hash(appointmentPatient)}) }}"
                                           class="btn btn-success btn-block invoice-link">{{ 'app.invoice.new'|trans }}</a>

                                    {% endif %}
                                {% else %}

                                    {% if not appointmentPatient.invoice.isPaid %}

                                        <div class="btn-group invoice-or-pack-btn">
                                            <button class="btn btn-default btn-block dropdown-toggle "
                                                    data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">{{ 'app.invoice.view_or_pay'|trans }}
                                                <span class="caret"></span></button>

                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a href="{{ path('invoice_view',{'id':app_hash(appointmentPatient.invoice)}) }}"
                                                       class="">{{ 'app.invoice.view'|trans }}</a>
                                                </li>
                                                <li>
                                                    <a href="{{ path('invoice_update_from_appointment',{invoice: app_hash(appointmentPatient.invoice), appointment: app_hash(entity) }) }}">{{ 'app.invoice.pay_invoice'|trans }}</a>
                                                </li>
                                            </ul>
                                        </div>

                                    {% else %}

                                        <a href="{{ path('invoice_view',{'id':app_hash(appointmentPatient.invoice)}) }}"
                                           class="btn btn-default btn-block">{{ 'app.invoice.view'|trans }}</a>

                                    {% endif %}
                                {% endif %}

                                {% if not appointmentPatient.treatmentNote %}
                                    {% if appointmentPatient.patient.treatmentNotes|length > 0 %}
                                        {% set tnPath = path('appointment_treatment_note_index',{'id':app_hash(appointmentPatient.patient),'appointment':app_hash(entity)}) %}
                                    {% else %}
                                        {% set tnPath = path('appointment_treatment_note_create',{'patient':app_hash(appointmentPatient.patient), 'template':app_hash(defaultTemplate),'appointment':app_hash(entity)}) %}
                                    {% endif %}
                                    <a href="{{ tnPath }}"
                                       class="btn btn-default btn-block tn-link">{{ 'app.treatment_note.new'|trans }}</a>
                                {% else %}
                                    <a href="{{ path('treatment_note_view',{'patient':app_hash(appointmentPatient.patient),'treatmentNote':app_hash(appointmentPatient.treatmentNote)}) }}"
                                       class="btn btn-default btn-block tn-link">{{ 'app.treatment_note.view'|trans }}</a>
                                {% endif %}
                                <a href="{{ path('patient_recall_index_with_new',{'id':app_hash(appointmentPatient.patient)}) }}"
                                   class="btn btn-default btn-block">{{ 'app.recall.add'|trans }}</a>
                            </div>
                            <div class="clearfix"></div>
                        </div>

                    </div>
                </div>

            {% endfor %}

        </div>

        <div class="modal-footer">
            <a href="#" data-href="{{ path('event_delete',{'id':app_hash(entity, eventClass)}) }}"
               class="pull-left delete-apt" data-toggle="delete-confirmation-event"
               data-entity-label="{{ 'app.appointment.label'|trans }}">{{ 'app.action.delete'|trans }}</a>

            <a href="#" class="btn btn-default app-appointment-edit"
               data-entity-id="{{ app_hash(entity, eventClass) }}">{{ 'app.action.edit'|trans }}</a>

            <div class="btn-group app-appointment-cancel-container">
                <a class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                   aria-haspopup="true" aria-expanded="false">
                    {{ 'app.action.cancel'|trans }} <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% for reason in cancelReasons %}
                        <li><a href="#" class="app-appointment-cancel"
                               data-cancel-reason-id="{{ app_hash(reason) }}"
                               data-entity-id="{{ app_hash(entity) }}">{{ reason }}</a></li>
                    {% endfor %}
                    <li role="separator" class="divider"></li>
                    <li><a href="#" data-toggle="dropdown">{{ 'app.action.dont_cancel'|trans }}</a></li>
                </ul>
            </div>

            <a href="{{ path('calendar_event_reschedule',{'event':app_hash(entity, eventClass)}) }}"
               class="btn btn-default">{{ 'app.event.reschedule'|trans }}</a>
            <a href="{{ path('calendar_event_book_again',{'event':app_hash(entity, eventClass)}) }}"
               class="btn btn-default">{{ 'app.appointment.book_again'|trans }}</a>
        </div>

    </div>
</div>
