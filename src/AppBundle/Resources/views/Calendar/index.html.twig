{% extends 'inner.html.twig' %}
{% set header = 'app.calendar.label'|trans %}
{% set headerIcon = 'title-calendar' %}

{% block pageActions %}
    {#
    <a href="{{ path('appointment_create') }}"
       class="btn btn-primary btn-labeled app-appointment-create"><span class="btn-label"><i
                    class="glyphicon glyphicon-plus"></i></span>{{ 'app.appointment.new'|trans }}</a>
    #}
{% endblock %}

{% block body %}
    <section class="content-panel">
        <div id="calendar"></div>
    </section>

    <script>
        $(document).ready(function () {

            var INTERVAL = '{{ eventUtils.interval }}';
            var DAY_START = '{{ eventUtils.dayStart }}';
            var DAY_END = '{{ eventUtils.dayEnd }}';
            var BUSINESS_DAY_START = '{{ eventUtils.businessDayStart }}';
            var BUSINESS_DAY_END = '{{ eventUtils.businessDayEnd }}';
            var COLUMNS = {{ resources|raw }};
            var NUM_COLUMNS = COLUMNS.length;
            var CALENDAR = "#calendar";

            $(CALENDAR).fullCalendar({
                defaultView: 'multiColAgendaWeek',
                slotDuration: '00:' + INTERVAL + ':00',
                firstDay: 1,
                minTime: DAY_START,
                maxTime: DAY_END,
                height: 700,
                weekends: false,
                businessHours: {
                    start: BUSINESS_DAY_START,
                    end: BUSINESS_DAY_END,
                },
                views: {
                    multiColAgendaDay: {
                        type: 'multiColAgenda',
                        duration: {days: 1},
                        numColumns: NUM_COLUMNS,
                        columnHeaders: COLUMNS
                    },
                    multiColAgendaWeek: {
                        type: 'multiColAgenda',
                        duration: {weeks: 1},
                        numColumns: NUM_COLUMNS,
                        columnHeaders: COLUMNS,
                        columnFormat: 'ddd, D MMM',
                        titleFormat: 'D MMMM',
                        scrollTime: BUSINESS_DAY_START,
                    }
                },
                loading: function (isLoading, view) {
                    if (isLoading) {
                        loaderShow();
                    } else {
                        loaderHide();
                    }
                },
                eventRender: function (event, element) {
                    if (event.birthday) {
                        element.append('<div style="position: absolute; top: 3px; right: 2px;"><div style="border-radius: 50%;width: 14px;height: 14px; background: #fff; color: #000; text-align: center;"><div class="fc-treatment"><span class="fa fa-birthday-cake"></div></div></div>');
                    }
                },
                eventSources: [
                    Routing.generate('event_list')
                ],
                dayClick: function (date, jsEvent, view) {
                    {% if patient is defined %}
                    appointmentCreate(date.format(), '{{ patient }}');
                    {% else %}
                    appointmentCreate(date.format());
                    {% endif %}
                },
                eventClick: function (calEvent, jsEvent, view) {
                    eventEdit(calEvent.id);
                },
                eventAfterAllRender: function (view) {
                    var divider = $('.fc-divider').first();
                    var dividerOffset = divider.offset().left;
                    $('.fc-scroller').eq(3).scroll(function () {
                        var scrollLeft = $('.fc-scroller').eq(3).scrollLeft();
                        if (scrollLeft >= 0) {
                            var total = dividerOffset - scrollLeft;
                            $('.fc-head').css('left', total + 'px');
                        }
                        else {
                            $('.fc-head').css('position', 'relative');
                            $('.fc-head').css('left', dividerOffset + 'px');
                        }
                    });

                },
                eventDrop: function (event, delta, revertFunc) {
                    var url = Routing.generate('event_reschedule', {
                        'id': event.id,
                        'column': event.column,
                        'delta': delta.asMinutes()
                    });
                    $.ajax({
                        url: url,
                        type: "POST",
                        dataType: "json",
                        data: {},
                        success: function (data, textStatus) {
                            if (!data) {
                                $(CALENDAR).fullCalendar('refetchEvents');
                                notify('app.message.undefined_error', 'danger');
                                return;
                            }
                            $(CALENDAR).fullCalendar('updateEvent', event);
                            notify('app.appointment.message.rescheduled', 'success');
                        },
                        error: function () {
                            $(CALENDAR).fullCalendar('refetchEvents');
                            notify('app.message.undefined_error', 'danger');
                        }
                    });
                },
                eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                    var url = Routing.generate('event_resize', {'id': event.id, 'stop': event.end.format()});

                    if (event.start.format().split('T')[0] !== event.end.format().split('T')[0]) {
                        notify('app.event.message.cannot_resize_between_dates', 'danger');
                        revertFunc();
                        return;
                    }

                    $.ajax({
                        url: url,
                        type: "POST",
                        dataType: "json",
                        data: {},
                        success: function (data, textStatus) {
                            if (!data) {
                                $(CALENDAR).fullCalendar('refetchEvents');
                                notify('app.message.undefined_error', 'danger');
                                return;
                            }
                            $(CALENDAR).fullCalendar('updateEvent', event);
                            notify('app.appointment.message.resized', 'success');
                        },
                        error: function () {
                            $(CALENDAR).fullCalendar('refetchEvents');
                            notify('app.message.undefined_error', 'danger');
                        }
                    });
                },
                scrollTime: moment(),
                allDaySlot: false,
                slotEventOverlap: false,
                eventOverlap: false,
                header: {
                    //left: 'month,multiColAgendaWeek,multiColAgendaDay',
                    //center: 'title',
                    //right: 'today prev,next'
                    left: 'title',
                    center: '',
                    right: 'today prev,next'
                }
            });

        });
    </script>

    {% include "@App/Event/scripts.html.twig" %}
    {% include "@App/Event/modal.html.twig" %}
    {% include "@App/Appointment/include/modal.html.twig" %}
    {% include "@App/UnavailableBlock/include/modal.html.twig" %}

{% endblock %}
