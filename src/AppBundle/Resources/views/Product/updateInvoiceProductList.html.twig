<div class="form-group">
    <div>

        {% set items = [] %}
        {% set copiedItems = [] %}

        {% for item in form.invoiceProducts %}
            {% if item.vars.value.fromOtherInvoice == true or (item.vars.value.originalInvoice and not (item.vars.value.originalInvoice.id == entity.id)) %}
                {% set copiedItems = copiedItems|merge([item]) %}
            {% else %}
                {% set items = items|merge([item]) %}
            {% endif %}
        {% endfor %}

        <div class="col-labels hidden-xs">
            <div class="row">
                <div class="col-sm-4">{{ 'app.product.label'|trans }}</div>
                <div class="col-sm-3">{{ 'app.product.price'|trans }}</div>
                <div class="col-sm-1">{{ 'app.invoice.quantity_short'|trans }}</div>
                <div class="col-sm-3">{{ 'app.invoice.sub_total'|trans }}</div>
                <div class="col-sm-1">&nbsp;</div>
            </div>
        </div>

        <div id="invoiceProducts" class=""
             data-prototype="{{ form_widget(form.invoiceProducts.vars.prototype)|e }}">

            <div class="repeater-rows">
                {% for child in items %}
                    <div class="child-container">
                        {{ form_errors(child) }}
                        {{ form_widget(child) }}
                    </div>
                {% endfor %}
            </div>

            <a href="#" id="add-product" class="btn btn-default">{{ 'app.product.add'|trans }}</a>

            {% if copiedItems|length > 0 %}
                <div class="previous-invoice">
                    <h4>{{ 'app.invoice.from_previous'|trans }}</h4>
                    {% for child in copiedItems %}
                        <div class="child-container">
                            {{ form_errors(child) }}
                            {{ form_widget(child) }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        </div>

        <script type="text/javascript">

            $(document).ready(function () {

                var count = '{{ form.invoiceProducts|length }}';

                $('#add-product').click(function (e) {
                    e.preventDefault();

                    var list = jQuery('#invoiceProducts');

                    var newWidget = list.attr('data-prototype');
                    newWidget = newWidget.replace(/__name__/g, count);
                    count++;

                    var newLi = $('<div class="child-container"></div>').html(newWidget);
                    newLi.prependTo($(list).find('.repeater-rows:first'));

                    render();
                });

                $('body').on('click', '#delete-product', function (e) {
                    e.preventDefault();

                    var itemContainer = $(this).parents('div.child-container:first');

                    $(itemContainer).remove();
                    recalcPayments();
                });

                $('#invoiceProducts').on('change', '.app-product-selector', function (e) {
                    var itemContainer = $(this).parents('.child-container:first');
                    var priceField = $(itemContainer).find('input[data-price]:first');
                    $(priceField).prop('disabled', true);

                    var url = Routing.generate('product_price_view', {
                        'id': $(this).val()
                    });

                    $.post(url, {}, function (data) {
                        var response = jQuery.parseJSON(data);
                        $(priceField).val(response.price);
                        $(priceField).prop('disabled', false);
                        recalc(itemContainer);
                    }, 'json');

                });

                $('#invoiceProducts').on('change keyup', 'input[data-quantity]', function (e) {
                    var itemContainer = $(this).parents('.child-container:first');
                    recalc(itemContainer);
                });

                $('#invoiceProducts').on('change keyup', 'input[data-price]', function (e) {
                    var itemContainer = $(this).parents('.child-container:first');
                    recalc(itemContainer);
                });

                function recalc(itemContainer) {
                    var priceField = $(itemContainer).find('input[data-price]:first');
                    var price = parseFloat($(priceField).val().replace(/[\s,]+/g, ""));

                    var amountField = $(itemContainer).find('input[data-quantity]:first');
                    var totalField = $(itemContainer).find('input[data-total]:first');

                    var total = price * parseFloat($(amountField).val());

                    $(totalField).val(total.toFixed(2));
                    recalcPayments();
                }
            })
        </script>

    </div>
</div>
<div class="clearfix"></div>

